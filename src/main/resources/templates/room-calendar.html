<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio do Quarto</title>
    <link rel="stylesheet" th:href="@{/css/room-calendar.css}">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">Interactive Edge</h1>
            <nav class="nav">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/guest" class="nav-link">H√≥spedes</a>
                <a href="/room" class="nav-link">Quartos</a>
                <div class="dropdown">
                    <a class="nav-link dropdown-link">Gerenciar</a>
                    <div class="dropdown-content">
                        <a href="/reserve">Reservas</a>
                        <a href="/financas">Finan√ßas</a>
                    </div>
                </div>
                <a href="/calendario" class="nav-link">Calend√°rio</a>
                <div class="user-info" id="userInfo">
                    <!-- Informa√ß√µes do usu√°rio ser√£o carregadas aqui -->
                </div>
                <a href="#" class="nav-link" id="logoutBtn">Sair</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Alertas -->
            <div id="alertContainer"></div>

            <!-- Cabe√ßalho do Calend√°rio -->
            <div class="calendar-header">
                <div class="room-info">
                    <div class="room-number" id="roomNumberDisplay">Quarto </div>
                    <div class="room-type" id="roomTypeDisplay"></div>
                </div>
                <div class="calendar-nav">
                    <button class="btn btn-secondary btn-sm" id="prevMonthBtn">‚Äπ M√™s Anterior</button>
                    <h2 class="calendar-title" id="currentMonthDisplay"></h2>
                    <button class="btn btn-secondary btn-sm" id="nextMonthBtn">Pr√≥ximo M√™s ‚Ä∫</button>
                </div>
                <div>
                    <button class="btn btn-primary" id="newReservationBtn">Nova Reserva</button>
                    <button class="btn btn-secondary" id="backToRoomsBtn">‚Üê Voltar para Quartos</button>
                </div>
            </div>

            <!-- Grid do Calend√°rio -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Calend√°rio de Reservas</h2>
                    <div class="loading" id="calendarLoading" style="display: none;"></div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Cabe√ßalhos dos dias -->
                    <div class="calendar-day-header">Dom</div>
                    <div class="calendar-day-header">Seg</div>
                    <div class="calendar-day-header">Ter</div>
                    <div class="calendar-day-header">Qua</div>
                    <div class="calendar-day-header">Qui</div>
                    <div class="calendar-day-header">Sex</div>
                    <div class="calendar-day-header">S√°b</div>
                    
                    <!-- Dias ser√£o carregados via JavaScript -->
                </div>
            </div>

            <!-- Formul√°rio de Nova Reserva -->
            <div class="card" id="reservationForm" style="display: none;">
                <div class="card-header">
                    <h2 class="card-title">Nova Reserva</h2>
                </div>
                <form id="reserveForm">
                    <div class="form-group">
                        <label class="form-label">Datas Selecionadas</label>
                        <div id="selectedDates" class="selected-dates">
                            <!-- Selected dates will appear here -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="guestName" class="form-label">Nome do H√≥spede</label>
                        <input 
                            type="text" 
                            id="guestName" 
                            name="guestName" 
                            class="form-control" 
                            placeholder="Digite o nome do h√≥spede"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" id="reserveBtn" class="btn btn-primary">
                            Reservar
                        </button>
                        <button type="button" id="cancelReservationBtn" class="btn btn-danger">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de Reservas -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Reservas do Quarto</h2>
                </div>
                <div class="reservations-list" id="reservationsList">
                    <!-- Reservas ser√£o carregadas via JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Gerenciar Reserva -->
    <div id="manageModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Gerenciar Reserva</h3>
                <span class="close" onclick="window.roomCalendar.closeModal('manageModal')">&times;</span>
            </div>
            <div class="management-card">
                <div id="manageReservationContent">
                    <!-- Conte√∫do din√¢mico ser√° carregado aqui -->
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p><strong>&copy; Interactive Edge System</strong></p>
        </div>
    </footer>

    <script>
        // Classe principal para o calend√°rio do quarto
        class RoomCalendar {
            constructor() {
                this.API_BASE_URL = 'http://191.217.217.80:8080';
                // this.API_BASE_URL = 'http://localhost:8081';
                this.currentDate = new Date();
                this.currentRoom = null;
                this.roomReservations = [];
                this.selectedDates = new Set();
                this.allReservations = [];
                this.init();
            }

            async init() {
                await this.loadRoomData();
                this.setupEventListeners();
                this.loadUserInfo();
            }

            // Fun√ß√£o para obter o token JWT
            getToken() {
                return localStorage.getItem('jwtToken');
            }

            // Fun√ß√£o para verificar autentica√ß√£o
            checkAuth() {
                const token = this.getToken();
                if (!token) {
                    window.location.href = '/login';
                    return false;
                }
                
                const tokenExpiry = localStorage.getItem('tokenExpiry');
                if (tokenExpiry && Date.now() > parseInt(tokenExpiry)) {
                    this.logout();
                    return false;
                }
                
                return true;
            }

            // Fun√ß√£o para fazer logout
            logout() {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('tokenExpiry');
                localStorage.removeItem('userInfo');
                window.location.href = '/login';
            }

            // Fun√ß√£o para carregar informa√ß√µes do usu√°rio
            loadUserInfo() {
                try {
                    const userInfoElement = document.getElementById('userInfo');
                    const userEmail = localStorage.getItem('userInfo');
                    
                    if (userInfoElement && userEmail) {
                        userInfoElement.textContent = `Usu√°rio: ${userEmail}`;
                    }
                } catch (error) {
                    console.error('Erro ao carregar informa√ß√µes do usu√°rio:', error);
                }
            }

            // Fun√ß√£o para mostrar alertas
            showAlert(message, type = 'success') {
                const alertContainer = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                
                alertContainer.appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }

            // Fun√ß√£o para fazer requisi√ß√µes √† API
            async apiRequest(url, options = {}) {
                const token = this.getToken();
                
                const defaultOptions = {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                };

                const mergedOptions = { ...defaultOptions, ...options };

                try {
                    const response = await fetch(url, mergedOptions);
                    
                    if (response.status === 401 || response.status === 403) {
                        this.logout();
                        return null;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API request failed:', error);
                    this.showAlert('Erro na comunica√ß√£o com o servidor', 'error');
                    return null;
                }
            }

            // Carregar dados do quarto
            async loadRoomData() {
                if (!this.checkAuth()) return;

                // Obter dados do quarto do localStorage
                const savedRoom = localStorage.getItem('selectedRoom');
                if (!savedRoom) {
                    this.showAlert('Nenhum quarto selecionado', 'error');
                    window.location.href = '/room';
                    return;
                }

                this.currentRoom = JSON.parse(savedRoom);
                document.getElementById('roomNumberDisplay').textContent = `Quarto #${this.currentRoom.number}`;

                // Carregar dados detalhados do quarto
                const room = await this.apiRequest(`${this.API_BASE_URL}/room/find/${this.currentRoom.id}`);
                if (room) {
                    document.getElementById('roomTypeDisplay').textContent = room.exclusiveRoom ? 'Quarto Exclusivo' : 'Quarto Compartilhado';
                }

                // Carregar reservas
                await this.loadReservations();
            }

            // Carregar reservas do quarto
            async loadReservations() {
                const calendarLoading = document.getElementById('calendarLoading');
                calendarLoading.style.display = 'inline-block';

                try {
                    // Carregar todas as reservas
                    this.allReservations = await this.apiRequest(`${this.API_BASE_URL}/reserve/all`) || [];
                    
                    // Filtrar reservas para este quarto espec√≠fico
                    this.roomReservations = this.allReservations.filter(reserve => 
                        reserve.rooms && reserve.rooms.some(room => room.id === this.currentRoom.id)
                    );
                    
                    console.log('Reservas do quarto:', this.roomReservations);
                    this.renderCalendar();
                    this.renderReservationsList();
                } catch (error) {
                    console.error('Error loading reservations:', error);
                    this.showAlert('Erro ao carregar reservas', 'error');
                }

                calendarLoading.style.display = 'none';
            }

            // Renderizar calend√°rio
            renderCalendar() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                // Atualizar display do m√™s
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                document.getElementById('currentMonthDisplay').textContent = `${monthNames[month]} ${year}`;

                const calendarGrid = document.getElementById('calendarGrid');
                // Limpar calend√°rio (mantendo cabe√ßalhos)
                while (calendarGrid.children.length > 7) {
                    calendarGrid.removeChild(calendarGrid.lastChild);
                }

                // Primeiro dia do m√™s
                const firstDay = new Date(year, month, 1);
                // √öltimo dia do m√™s
                const lastDay = new Date(year, month + 1, 0);
                // Dia da semana do primeiro dia (0 = Domingo, 6 = S√°bado)
                const firstDayOfWeek = firstDay.getDay();

                // Adicionar dias vazios no in√≠cio se necess√°rio
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day other-month';
                    calendarGrid.appendChild(emptyDay);
                }

                // Adicionar dias do m√™s
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dayDate = new Date(year, month, day);
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    // Verificar se √© hoje
                    if (dayDate.getTime() === today.getTime()) {
                        dayElement.classList.add('today');
                    }

                    // Verificar se √© data passada
                    if (dayDate < today) {
                        dayElement.classList.add('past');
                    }

                    // Verificar se h√° reserva para este dia
                    const reservationForDay = this.getReservationForDate(dayDate);
                    const dateString = this.formatDate(dayDate);
                    const isSelected = this.selectedDates.has(dateString);

                    if (reservationForDay) {
                        dayElement.classList.add('reserved');
                    } else if (!dayElement.classList.contains('past')) {
                        dayElement.classList.add('available');
                    }

                    if (isSelected) {
                        dayElement.classList.add('selected');
                    }

                    // N√∫mero do dia
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = day;
                    dayElement.appendChild(dayNumber);

                    // Informa√ß√µes da reserva (se houver)
                    if (reservationForDay) {
                        const reservationInfo = document.createElement('div');
                        reservationInfo.className = 'reservation-info';
                        
                        // Mostrar nomes dos h√≥spedes
                        reservationForDay.guestNames.forEach(guestName => {
                            const guestElement = document.createElement('div');
                            guestElement.className = 'guest-name';
                            guestElement.textContent = guestName;
                            reservationInfo.appendChild(guestElement);
                        });

                        // Status da reserva
                        const status = document.createElement('div');
                        status.className = `reservation-status status-${reservationForDay.status.toLowerCase()}`;
                        
                        // Traduzir status
                        const statusText = {
                            'CONFIRMED': 'Confirmada',
                            'CHECKED_IN': 'Check-in',
                            'CHECKED_OUT': 'Check-out',
                            'CANCELLED': 'Cancelada'
                        }[reservationForDay.status] || reservationForDay.status;
                        
                        status.textContent = statusText;
                        reservationInfo.appendChild(status);

                        dayElement.appendChild(reservationInfo);
                    }

                    // Adicionar evento de clique apenas para dias dispon√≠veis e n√£o passados
                    if (dayElement.classList.contains('available') || isSelected) {
                        dayElement.addEventListener('click', () => this.toggleDateSelection(dayDate));
                    }

                    calendarGrid.appendChild(dayElement);
                }
            }

            // Alternar sele√ß√£o de data
            toggleDateSelection(date) {
                const dateString = this.formatDate(date);
                
                if (this.selectedDates.has(dateString)) {
                    this.selectedDates.delete(dateString);
                } else {
                    this.selectedDates.add(dateString);
                }
                
                this.updateSelectedDatesDisplay();
                this.renderCalendar();
            }

            // Atualizar display das datas selecionadas
            updateSelectedDatesDisplay() {
                const selectedDatesContainer = document.getElementById('selectedDates');
                selectedDatesContainer.innerHTML = '';
                
                const sortedDates = Array.from(this.selectedDates).sort();
                
                sortedDates.forEach(dateString => {
                    const dateTag = document.createElement('div');
                    dateTag.className = 'date-tag';
                    
                    const date = this.parseDate(dateString);
                    const formattedDate = date.toLocaleDateString('pt-BR');
                    
                    dateTag.innerHTML = `
                        ${formattedDate}
                        <button type="button" data-date="${dateString}">√ó</button>
                    `;
                    
                    const removeButton = dateTag.querySelector('button');
                    removeButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectedDates.delete(dateString);
                        this.updateSelectedDatesDisplay();
                        this.renderCalendar();
                    });
                    
                    selectedDatesContainer.appendChild(dateTag);
                });
            }

            // Obter reserva para uma data espec√≠fica
            getReservationForDate(date) {
                const dateString = this.formatDate(date);
                
                for (const reservation of this.roomReservations) {
                    if (reservation.reservedDays && Array.isArray(reservation.reservedDays)) {
                        // Verificar se a data est√° na lista de datas reservadas
                        const isReserved = reservation.reservedDays.some(reservedDate => 
                            reservedDate === dateString
                        );

                        if (isReserved && reservation.reserveStatus !== 'CANCELLED') {
                            // Pegar todos os nomes dos h√≥spedes
                            const guestNames = reservation.guest && reservation.guest.length > 0 ? 
                                reservation.guest.map(guest => guest.name).filter(name => name) : ['N/A'];
                            
                            return {
                                guestNames: guestNames,
                                status: reservation.reserveStatus || 'CONFIRMED'
                            };
                        }
                    }
                }
                return null;
            }

            // Formatar data como yyyy-MM-dd
            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Parse date from string
            parseDate(dateString) {
                const parts = dateString.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]);
            }

            // Renderizar lista de reservas
            renderReservationsList() {
                const reservationsList = document.getElementById('reservationsList');
                reservationsList.innerHTML = '';

                if (this.roomReservations.length === 0) {
                    reservationsList.innerHTML = `
                        <div class="reservation-item">
                            <p>Nenhuma reserva encontrada para este quarto.</p>
                        </div>
                    `;
                    return;
                }

                // Ordenar reservas por data (mais recente primeiro)
                const sortedReservations = [...this.roomReservations].sort((a, b) => {
                    const dateA = a.reservedDays && a.reservedDays[0] ? new Date(a.reservedDays[0]) : new Date(0);
                    const dateB = b.reservedDays && b.reservedDays[0] ? new Date(b.reservedDays[0]) : new Date(0);
                    return dateB - dateA;
                });

                sortedReservations.forEach(reservation => {
                    const reservationItem = document.createElement('div');
                    reservationItem.className = 'reservation-item';

                    // Formatar datas
                    const dates = reservation.reservedDays && Array.isArray(reservation.reservedDays) ?
                        reservation.reservedDays.map(date => {
                            const [year, month, day] = date.split('-');
                            return `${day}/${month}/${year}`;
                        }).join(', ') : 'Datas n√£o dispon√≠veis';

                    // Status da reserva em portugu√™s
                    const statusText = {
                        'CONFIRMED': 'Confirmada',
                        'CHECKED_IN': 'Check-in Realizado',
                        'CHECKED_OUT': 'Check-out Realizado',
                        'CANCELLED': 'Cancelada'
                    }[reservation.reserveStatus] || 'Desconhecido';

                    const statusClass = `status-${reservation.reserveStatus ? reservation.reserveStatus.toLowerCase() : 'unknown'}`;

                    // Lista de h√≥spedes
                    let guestsHtml = '';
                    if (reservation.guest && Array.isArray(reservation.guest) && reservation.guest.length > 0) {
                        guestsHtml = `
                            <div class="reservation-guests">
                                <strong>H√≥spedes (${reservation.guest.length}):</strong>
                                <div style="margin-top: 0.5rem;">
                                    ${reservation.guest.map(guest => `
                                        <div class="guest-item">
                                            <span>${guest.name || `ID: ${guest.id}`}</span>
                                            ${guest.email ? `<small class="guest-email">${guest.email}</small>` : ''}
                                            ${guest.phone ? `<small class="guest-email">${guest.phone}</small>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        guestsHtml = '<div class="reservation-guests"><strong>H√≥spedes:</strong> Nenhum h√≥spede associado</div>';
                    }

                    reservationItem.innerHTML = `
                        <div class="reservation-header">
                            <div><strong>Reserva #${reservation.id}</strong></div>
                            <div class="reservation-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="reservation-dates">
                            <strong>Datas:</strong> ${dates}
                        </div>
                        ${guestsHtml}
                        ${reservation.checkIn && reservation.checkIn.length > 0 ? 
                            `<div class="reservation-checkin">
                                <strong>Check-in:</strong> ${new Date(reservation.checkIn[0]).toLocaleString('pt-BR')}
                            </div>` : ''
                        }
                        ${reservation.checkOut && reservation.checkOut.length > 0 ? 
                            `<div class="reservation-checkout">
                                <strong>Check-out:</strong> ${new Date(reservation.checkOut[0]).toLocaleString('pt-BR')}
                            </div>` : ''
                        }
                        <div class="reservation-actions">
                            <button class="btn btn-info btn-sm" onclick="window.roomCalendar.manageReservation(${reservation.id})">
                                üëÅÔ∏è Gerenciar
                            </button>
                            ${reservation.reserveStatus === 'CONFIRMED' ? `
                                <button class="btn btn-success btn-sm" onclick="window.roomCalendar.performCheckIn(${reservation.id})">
                                    ‚úÖ Check-in
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="window.roomCalendar.cancelReservationById(${reservation.id})">
                                    ‚ùå Cancelar
                                </button>
                            ` : ''}
                            ${reservation.reserveStatus === 'CHECKED_IN' ? `
                                <button class="btn btn-primary btn-sm" onclick="window.roomCalendar.performCheckOut(${reservation.id})">
                                    üèÅ Check-out
                                </button>
                            ` : ''}
                        </div>
                    `;

                    reservationsList.appendChild(reservationItem);
                });
            }

            // Nova reserva
            openReservationForm() {
                this.selectedDates.clear();
                this.updateSelectedDatesDisplay();
                document.getElementById('reservationForm').style.display = 'block';
                this.renderCalendar();
            }

            closeReservationForm() {
                document.getElementById('reservationForm').style.display = 'none';
                document.getElementById('reserveForm').reset();
                this.selectedDates.clear();
                this.updateSelectedDatesDisplay();
                this.renderCalendar();
            }

            // Criar nova reserva
            async createReservation(event) {
                event.preventDefault();
                
                const guestName = document.getElementById('guestName').value;
                
                if (this.selectedDates.size === 0) {
                    this.showAlert('Selecione pelo menos uma data para reservar', 'error');
                    return;
                }
                
                if (!guestName) {
                    this.showAlert('Preencha o nome do h√≥spede', 'error');
                    return;
                }
                
                const reserveBtn = document.getElementById('reserveBtn');
                reserveBtn.disabled = true;
                reserveBtn.innerHTML = '<div class="loading"></div> Reservando...';
                
                try {
                    const datesArray = Array.from(this.selectedDates).map(dateStr => {
                        const date = this.parseDate(dateStr);
                        return this.formatDate(date);
                    });
                    
                    const reservationData = {
                        dates: datesArray,
                        guestName: guestName,
                        roomNumber: this.currentRoom.number
                    };
                    
                    console.log('Enviando dados:', reservationData);
                    
                    const response = await this.apiRequest(`${this.API_BASE_URL}/reserve/insert`, {
                        method: 'POST',
                        body: JSON.stringify(reservationData)
                    });
                    
                    if (response) {
                        this.showAlert('Reserva criada com sucesso!', 'success');
                        this.closeReservationForm();
                        await this.loadReservations();
                    } else {
                        throw new Error('Erro ao criar reserva');
                    }
                } catch (error) {
                    console.error('Erro ao criar reserva:', error);
                    this.showAlert(`Erro ao criar reserva: ${error.message}`, 'error');
                } finally {
                    reserveBtn.disabled = false;
                    reserveBtn.innerHTML = 'Reservar';
                }
            }

            // Gerenciar reserva
            async manageReservation(reservationId) {
                try {
                    const response = await this.apiRequest(`${this.API_BASE_URL}/reserve/find/${reservationId}`);
                    
                    if (response) {
                        this.openManageModal(response);
                    } else {
                        throw new Error('Erro ao carregar reserva');
                    }
                } catch (error) {
                    console.error('Erro ao carregar reserva:', error);
                    this.showAlert('Erro ao carregar reserva', 'error');
                }
            }

            // Abrir modal de gerenciamento
            openManageModal(reservation) {
                const container = document.getElementById('manageReservationContent');
                
                const html = `
                    <div class="management-section">
                        <h4 class="section-title">üìä Informa√ß√µes da Reserva</h4>
                        <div><strong>ID:</strong> ${reservation.id}</div>
                        <div><strong>Status:</strong> ${this.getStatusText(reservation.reserveStatus)}</div>
                        <div><strong>H√≥spede Principal:</strong> ${this.getGuestName(reservation)}</div>
                        <div><strong>Quarto:</strong> ${this.getRoomNumber(reservation)}</div>
                    </div>

                    <div class="management-section">
                        <h4 class="section-title">üìÖ Datas da Reserva</h4>
                        <div class="current-dates">
                            ${this.formatCurrentDates(reservation.reservedDays)}
                        </div>
                    </div>

                    <div class="management-section">
                        <h4 class="section-title">üë• H√≥spedes</h4>
                        <div class="guest-list">
                            ${this.formatGuestList(reservation.guest)}
                        </div>
                    </div>

                    <div class="quick-actions">
                        ${reservation.reserveStatus === 'CONFIRMED' ? `
                            <button class="btn btn-success" onclick="window.roomCalendar.performCheckIn(${reservation.id})">
                                ‚úÖ Check-in
                            </button>
                            <button class="btn btn-danger" onclick="window.roomCalendar.cancelReservationById(${reservation.id})">
                                ‚ùå Cancelar
                            </button>
                        ` : ''}
                        ${reservation.reserveStatus === 'CHECKED_IN' ? `
                            <button class="btn btn-primary" onclick="window.roomCalendar.performCheckOut(${reservation.id})">
                                üèÅ Check-out
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="window.roomCalendar.closeModal('manageModal')">
                            Fechar
                        </button>
                    </div>
                `;

                container.innerHTML = html;
                document.getElementById('manageModal').style.display = 'block';
            }

            // Fun√ß√µes auxiliares para o modal
            getStatusText(status) {
                const statusMap = {
                    'CONFIRMED': 'Confirmada',
                    'CANCELLED': 'Cancelada',
                    'CHECKED_IN': 'Check-in Realizado',
                    'CHECKED_OUT': 'Check-out Realizado'
                };
                return statusMap[status] || status;
            }

            getGuestName(reservation) {
                if (reservation.guest && reservation.guest.length > 0) {
                    return reservation.guest[0].name;
                }
                return 'N/A';
            }

            getRoomNumber(reservation) {
                if (reservation.rooms && reservation.rooms.length > 0) {
                    return reservation.rooms[0].number;
                }
                return 'N/A';
            }

            formatCurrentDates(dates) {
                if (!dates || (Array.isArray(dates) && dates.length === 0)) {
                    return '<p>Nenhuma data definida</p>';
                }
                
                try {
                    const datesArray = Array.isArray(dates) ? dates : Array.from(dates);
                    const sortedDates = datesArray.sort();

                    return sortedDates.map(date => {
                        const parsedDate = this.parseDate(date);
                        const formattedDate = parsedDate.toLocaleDateString('pt-BR');
                        return `
                            <div class="date-item">
                                <span>${formattedDate}</span>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Erro ao formatar datas:', error);
                    return '<p>Erro ao carregar datas</p>';
                }
            }

            formatGuestList(guests) {
                if (!guests || guests.length === 0) return '<p>Nenhum h√≥spede</p>';
                
                const guestArray = Array.isArray(guests) ? guests : Array.from(guests);
                
                return guestArray.map(guest => `
                    <div class="guest-item">
                        <span>${guest.name || 'N/A'} ${guest.rg ? `- ${guest.rg}` : ''} ${guest.phone ? `- ${guest.phone}` : ''}</span>
                    </div>
                `).join('');
            }

            // Fechar modal
            closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            // Check-in
            async performCheckIn(reservationId) {
                try {
                    const response = await this.apiRequest(`${this.API_BASE_URL}/reserve/check-in/${reservationId}`, {
                        method: 'PUT'
                    });

                    if (response) {
                        this.showAlert('Check-in realizado com sucesso!', 'success');
                        this.closeModal('manageModal');
                        await this.loadReservations();
                    } else {
                        throw new Error('Erro ao realizar check-in');
                    }
                } catch (error) {
                    console.error('Erro no check-in:', error);
                    this.showAlert(`Erro no check-in: ${error.message}`, 'error');
                }
            }

            // Check-out
            async performCheckOut(reservationId) {
                try {
                    const response = await this.apiRequest(`${this.API_BASE_URL}/reserve/check-out/${reservationId}`, {
                        method: 'PUT'
                    });

                    if (response) {
                        this.showAlert('Check-out realizado com sucesso!', 'success');
                        this.closeModal('manageModal');
                        await this.loadReservations();
                    } else {
                        throw new Error('Erro ao realizar check-out');
                    }
                } catch (error) {
                    console.error('Erro no check-out:', error);
                    this.showAlert(`Erro no check-out: ${error.message}`, 'error');
                }
            }

            // Cancelar reserva
            async cancelReservationById(reservationId) {
                if (!confirm('Tem certeza que deseja cancelar esta reserva?')) {
                    return;
                }

                try {
                    const response = await this.apiRequest(`${this.API_BASE_URL}/reserve/cancele/${reservationId}`, {
                        method: 'PUT'
                    });

                    if (response) {
                        this.showAlert('Reserva cancelada com sucesso!', 'success');
                        this.closeModal('manageModal');
                        await this.loadReservations();
                    } else {
                        throw new Error('Erro ao cancelar reserva');
                    }
                } catch (error) {
                    console.error('Erro ao cancelar reserva:', error);
                    this.showAlert(`Erro ao cancelar reserva: ${error.message}`, 'error');
                }
            }

            // Navega√ß√£o do calend√°rio
            previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.renderCalendar();
            }

            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.renderCalendar();
            }

            // Configurar event listeners
            setupEventListeners() {
                // Navega√ß√£o do calend√°rio
                document.getElementById('prevMonthBtn').addEventListener('click', () => this.previousMonth());
                document.getElementById('nextMonthBtn').addEventListener('click', () => this.nextMonth());

                // Bot√£o nova reserva
                document.getElementById('newReservationBtn').addEventListener('click', () => this.openReservationForm());

                // Bot√£o cancelar reserva
                document.getElementById('cancelReservationBtn').addEventListener('click', () => this.closeReservationForm());

                // Formul√°rio de reserva
                document.getElementById('reserveForm').addEventListener('submit', (e) => this.createReservation(e));

                // Bot√£o voltar
                document.getElementById('backToRoomsBtn').addEventListener('click', () => {
                    window.location.href = '/room';
                });

                // Bot√£o logout
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });

                // Fechar modal ao clicar fora
                window.addEventListener('click', (event) => {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (event.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Inicializar quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', () => {
            window.roomCalendar = new RoomCalendar();
        });
    </script>
</body>
</html>