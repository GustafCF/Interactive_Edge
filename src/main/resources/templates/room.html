<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Quartos</title>
    <link rel="stylesheet" th:href="@{/css/room.css}">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">Interactive Edge</h1>
            <nav class="nav">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/guest" class="nav-link">H√≥spedes</a>
                <a href="/room" class="nav-link active">Quartos</a>
                <div class="dropdown">
                    <a class="nav-link dropdown-link">Gerenciar</a>
                    <div class="dropdown-content">
                        <a href="/reserve">Reservas</a>
                        <a href="/financas">Finan√ßas</a>
                    </div>
                </div>
                <a href="/calendario" class="btn-calendar">
                    üìÖ Calend√°rio
                </a>
                <div class="user-info" id="userInfo">
                    <!-- Informa√ß√µes do usu√°rio ser√£o carregadas aqui -->
                </div>
                <a href="#" class="nav-link" id="logoutBtn">Sair</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Alertas -->
            <div id="alertContainer"></div>

            <!-- Estat√≠sticas -->
            <div class="stats-grid" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number" id="totalRooms">0</div>
                    <div class="stat-label">Total de Quartos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="availableRooms">0</div>
                    <div class="stat-label">Quartos Dispon√≠veis</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="occupiedRooms">0</div>
                    <div class="stat-label">Quartos Ocupados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sharedRooms">0</div>
                    <div class="stat-label">Quartos Compartilhados</div>
                </div>
            </div>

            <!-- Cabe√ßalho da P√°gina -->
            <div class="page-header">
                <h1>Gerenciar Quartos</h1>
                <button class="btn btn-primary" id="addRoomBtn">
                    + Adicionar Quarto
                </button>
            </div>

            <!-- A√ß√µes R√°pidas -->
            <div class="quick-actions">
                <button class="btn btn-success" id="refreshBtn">
                    üîÑ Atualizar Lista
                </button>
                <button class="btn btn-primary" id="filterAvailableBtn">
                    üü¢ Filtrar Dispon√≠veis
                </button>
                <button class="btn btn-primary" id="filterOccupiedBtn">
                    üî¥ Filtrar Ocupados
                </button>
                <button class="btn btn-primary" id="showAllBtn">
                    üìã Mostrar Todos
                </button>
                <!-- Bot√£o de ordena√ß√£o adicionado -->
                <button class="btn btn-primary" id="sortRoomsBtn">
                    üîΩ Ordenar
                </button>
            </div>

            <!-- Lista de Quartos -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Lista de Quartos</h2>
                    <div class="loading" id="tableLoading" style="display: none;"></div>
                </div>
                <div class="table-responsive">
                    <table class="table" id="roomsTable">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Status</th>
                                <th>Tipo</th>
                                <th>Pre√ßo</th>
                                <th>Camas</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="roomsTableBody">
                            <!-- Dados ser√£o carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Adicionar/Editar Quarto -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Adicionar Quarto</h3>
                <span class="close">&times;</span>
            </div>
            <form id="roomForm">
                <input type="hidden" id="roomId">
                <div class="form-group">
                    <label for="roomNumber" class="form-label">N√∫mero do Quarto</label>
                    <input type="number" class="form-control" id="roomNumber" required min="1">
                </div>
                <div class="form-group">
                    <label for="roomType" class="form-label">Tipo de Quarto</label>
                    <select class="form-control" id="roomType" required>
                        <option value="">Selecione o tipo</option>
                        <option value="SHARED">Compartilhado</option>
                        <option value="EXCLUSIVE">Exclusivo</option>
                        <option value="SUITE">Su√≠te</option>
                        <option value="STUDIO">Studio</option>
                        <option value="ROOM_SHARED_BATHROOM">Quarto com Banheiro Compartilhado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="roomPrice" class="form-label">Pre√ßo (R$)</label>
                    <input type="number" class="form-control" id="roomPrice" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="roomStatus" class="form-label">Status</label>
                    <select class="form-control" id="roomStatus" required>
                        <option value="">Selecione o status</option>
                        <option value="VAGUE">Dispon√≠vel</option>
                        <option value="OCCUPIED">Ocupado</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-sm" id="submitBtn">
                        Salvar
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" id="cancelBtn">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Gerenciar Camas -->
    <div id="bedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Gerenciar Camas - Quarto <span id="bedRoomNumber"></span></h3>
                <span class="close">&times;</span>
            </div>
            <div class="form-group">
                <h4>Camas do Quarto:</h4>
                <div class="beds-container" id="bedsList">
                    <!-- Lista de camas ser√° carregada aqui -->
                </div>
                <div class="bed-actions">
                    <button class="btn btn-success btn-sm" id="addBedBtn">
                        + Adicionar Cama
                    </button>
                    <button class="btn btn-danger btn-sm" id="removeBedBtn">
                        - Remover Cama
                    </button>
                </div>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-primary btn-sm" id="closeBedModalBtn">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirmar Exclus√£o</h3>
                <span class="close">&times;</span>
            </div>
            <div class="form-group">
                <p>Tem certeza que deseja excluir o quarto <strong id="confirmRoomNumber"></strong>?</p>
                <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
                <button class="btn btn-primary" id="cancelDeleteBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p><strong>&copy; Interactive Edge System</strong></p>
        </div>
    </footer>

    <script>
        // Configura√ß√µes da API
        const API_BASE_URL = 'http://191.217.217.80:8080/room';
        // const API_BASE_URL = 'http://localhost:8081/room';
        let currentRooms = [];
        let currentFilter = 'all';
        let currentBedRoomId = null;
        let sortOrder = 'asc';

        const roomsTableBody = document.getElementById('roomsTableBody');
        const roomModal = document.getElementById('roomModal');
        const bedModal = document.getElementById('bedModal');
        const confirmModal = document.getElementById('confirmModal');
        const roomForm = document.getElementById('roomForm');
        const alertContainer = document.getElementById('alertContainer');
        const tableLoading = document.getElementById('tableLoading');
        const bedsList = document.getElementById('bedsList');

        const totalRoomsElement = document.getElementById('totalRooms');
        const availableRoomsElement = document.getElementById('availableRooms');
        const occupiedRoomsElement = document.getElementById('occupiedRooms');
        const sharedRoomsElement = document.getElementById('sharedRooms');

        function sortRooms() {
            currentRooms.sort((a, b) => {
                if (sortOrder === 'asc') {
                    return a.number - b.number;
                } else {
                    return b.number - a.number;
                }
            });
            renderRooms();
        }

        // Fun√ß√£o para alternar a ordem de classifica√ß√£o
        function toggleSortOrder() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            sortRooms();
            updateSortButtonText();
        }

        // Fun√ß√£o para atualizar o texto do bot√£o de ordena√ß√£o
        function updateSortButtonText() {
            const sortBtn = document.getElementById('sortRoomsBtn');
            if (sortBtn) {
                sortBtn.textContent = sortOrder === 'asc' ? 'üîΩ Ordenar' : 'üîº Ordenar';
            }
        }

        // Fun√ß√£o para obter o badge do tipo de quarto
        function getRoomTypeBadge(roomType) {
            switch(roomType) {
                case 'SHARED':
                    return '<span class="badge badge-shared">Compartilhado</span>';
                case 'EXCLUSIVE':
                    return '<span class="badge badge-exclusive">Exclusivo</span>';
                case 'SUITE':
                    return '<span class="badge badge-suite">Su√≠te</span>';
                case 'STUDIO':
                    return '<span class="badge badge-studio">Studio</span>';
                case 'ROOM_SHARED_BATHROOM':
                    return '<span class="badge badge-room-shared-bathroom">Banheiro Compartilhado</span>';
                default:
                    return '<span class="badge">Desconhecido</span>';
            }
        }

        // Fun√ß√£o para obter o token JWT
        function getToken() {
            return localStorage.getItem('jwtToken');
        }

        // Fun√ß√£o para verificar autentica√ß√£o
        function checkAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            
            // Verificar se o token expirou
            const tokenExpiry = localStorage.getItem('tokenExpiry');
            if (tokenExpiry && Date.now() > parseInt(tokenExpiry)) {
                logout();
                return false;
            }
            
            return true;
        }

        // Fun√ß√£o para fazer logout
        function logout() {
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('tokenExpiry');
            localStorage.removeItem('userInfo');
            window.location.href = '/login';
        }

        // Fun√ß√£o para carregar informa√ß√µes do usu√°rio
        async function loadUserInfo() {
            try {
                const userInfoElement = document.getElementById('userInfo');
                const userEmail = localStorage.getItem('userInfo');
                
                if (userInfoElement && userEmail) {
                    userInfoElement.textContent = `Usu√°rio: ${userEmail}`;
                } else if (userInfoElement) {
                    userInfoElement.textContent = 'Usu√°rio: N/A';
                }
            } catch (error) {
                console.error('Erro ao carregar informa√ß√µes do usu√°rio:', error);
                const userInfoElement = document.getElementById('userInfo');
                if (userInfoElement) {
                    userInfoElement.textContent = 'Usu√°rio: Erro';
                }
            }
        }

        // Fun√ß√£o para mostrar alertas
        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Fun√ß√£o para fazer requisi√ß√µes √† API
        async function apiRequest(url, options = {}) {
            const token = getToken();
            
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            const mergedOptions = { ...defaultOptions, ...options };

            try {
                const response = await fetch(url, mergedOptions);
                
                if (response.status === 401 || response.status === 403) {
                    showAlert('Sess√£o expirada. Fa√ßa login novamente.', 'error');
                    logout();
                    return null;
                }
                
                if (response.status === 400) {
                    const errorText = await response.text();
                    console.error('Bad Request details:', errorText);
                    showAlert('Erro na requisi√ß√£o. Verifique os dados.', 'error');
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Para respostas sem conte√∫do (como DELETE)
                if (response.status === 204) {
                    return { success: true };
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                showAlert('Erro na comunica√ß√£o com o servidor', 'error');
                return null;
            }
        }

        // Carregar lista de quartos
        async function loadRooms() {
            if (!checkAuth()) return;

            tableLoading.style.display = 'inline-block';
            
            const rooms = await apiRequest(`${API_BASE_URL}/all`);
            
            tableLoading.style.display = 'none';
            
            if (rooms) {
                currentRooms = rooms;
                sortRooms(); // Ordenar ap√≥s carregar
                updateStatistics();
                renderRooms();
            }
        }

        // Atualizar estat√≠sticas
        function updateStatistics() {
            const total = currentRooms.length;
            const available = currentRooms.filter(room => room.roomStatus === 'VAGUE').length;
            const occupied = currentRooms.filter(room => room.roomStatus === 'OCCUPIED').length;
            const shared = currentRooms.filter(room => room.roomType === 'SHARED').length;

            totalRoomsElement.textContent = total;
            availableRoomsElement.textContent = available;
            occupiedRoomsElement.textContent = occupied;
            sharedRoomsElement.textContent = shared;
        }

        // Renderizar tabela de quartos
        function renderRooms() {
            roomsTableBody.innerHTML = '';

            let filteredRooms = currentRooms;

            if (currentFilter === 'available') {
                filteredRooms = currentRooms.filter(room => room.roomStatus === 'VAGUE');
            } else if (currentFilter === 'occupied') {
                filteredRooms = currentRooms.filter(room => room.roomStatus === 'OCCUPIED');
            }

            if (filteredRooms.length === 0) {
                roomsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            Nenhum quarto encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            filteredRooms.forEach(room => {
                const row = document.createElement('tr');
                
                const statusBadge = room.roomStatus === 'VAGUE' ? 
                    '<span class="badge badge-vague">Dispon√≠vel</span>' : 
                    '<span class="badge badge-busy">Ocupado</span>';
                
                const typeBadge = getRoomTypeBadge(room.roomType);
                
                const bedsCount = room.beds ? room.beds.length : 0;
                
                row.innerHTML = `
                    <td>${room.number}</td>
                    <td>${statusBadge}</td>
                    <td>${typeBadge}</td>
                    <td class="price">R$ ${room.price ? room.price.toFixed(2) : '0.00'}</td>
                    <td>
                        ${bedsCount} camas
                        <button class="btn btn-info btn-xs" onclick="manageBeds(${room.id}, ${room.number})" title="Gerenciar Camas">
                            üõèÔ∏è
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewCalendar(${room.id}, ${room.number})" title="Ver Calend√°rio">
                            üìÖ Calend√°rio
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editRoom(${room.id})">
                            Editar
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete(${room.id}, ${room.number})">
                            Excluir
                        </button>
                    </td>
                `;
                
                roomsTableBody.appendChild(row);
            });
        }

        // Ver calend√°rio do quarto
        function viewCalendar(roomId, roomNumber) {
            // Salvar dados do quarto no localStorage
            localStorage.setItem('selectedRoom', JSON.stringify({
                id: roomId,
                number: roomNumber
            }));
            
            // Redirecionar para a p√°gina do calend√°rio
            window.location.href = '/room-calendar';
        }

        // Abrir modal para adicionar quarto
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Adicionar Quarto';
            document.getElementById('roomForm').reset();
            document.getElementById('roomId').value = '';
            roomModal.style.display = 'block';
        }

        // Editar quarto
        async function editRoom(roomId) {
            const room = await apiRequest(`${API_BASE_URL}/find/${roomId}`);
            
            if (room) {
                document.getElementById('modalTitle').textContent = 'Editar Quarto';
                document.getElementById('roomId').value = room.id;
                document.getElementById('roomNumber').value = room.number;
                document.getElementById('roomType').value = room.roomType;
                document.getElementById('roomPrice').value = room.price;
                document.getElementById('roomStatus').value = room.roomStatus;
                
                roomModal.style.display = 'block';
            }
        }

        // Gerenciar camas do quarto
        async function manageBeds(roomId, roomNumber) {
            currentBedRoomId = roomId;
            document.getElementById('bedRoomNumber').textContent = roomNumber;
            
            // Carregar dados atualizados do quarto
            const room = await apiRequest(`${API_BASE_URL}/find/${roomId}`);
            if (room) {
                renderBeds(room.beds);
                bedModal.style.display = 'block';
            }
        }

        // Renderizar lista de camas
        function renderBeds(beds) {
            bedsList.innerHTML = '';
            
            if (!beds || beds.length === 0) {
                bedsList.innerHTML = '<p>Nenhuma cama cadastrada neste quarto.</p>';
                return;
            }
            
            beds.forEach((bed, index) => {
                const bedElement = document.createElement('div');
                bedElement.className = 'bed-item';
                
                const bedStatus = bed.bedStatus === 'VAGUE' ? 
                    '<span class="badge badge-bed-vague">Dispon√≠vel</span>' : 
                    '<span class="badge badge-bed-busy">Ocupada</span>';
                
                bedElement.innerHTML = `
                    Cama ${index + 1} ${bedStatus}
                `;
                
                bedsList.appendChild(bedElement);
            });
        }

        // Adicionar cama
        async function addBed() {
            if (!currentBedRoomId) return;
            
            const result = await apiRequest(`${API_BASE_URL}/insert-bed/${currentBedRoomId}`, {
                method: 'POST'
            });
            
            if (result) {
                showAlert('Cama adicionada com sucesso!');
                // Atualizar a lista de camas
                manageBeds(currentBedRoomId, document.getElementById('bedRoomNumber').textContent);
                // Atualizar a lista principal de quartos
                loadRooms();
            }
        }

        // Remover cama
        async function removeBed() {
            if (!currentBedRoomId) return;
            
            const result = await apiRequest(`${API_BASE_URL}/remove-bed/${currentBedRoomId}`, {
                method: 'POST'
            });
            
            if (result) {
                showAlert('Cama removida com sucesso!');
                // Atualizar a lista de camas
                manageBeds(currentBedRoomId, document.getElementById('bedRoomNumber').textContent);
                // Atualizar a lista principal de quartos
                loadRooms();
            }
        }

        // Confirmar exclus√£o
        function confirmDelete(roomId, roomNumber) {
            document.getElementById('confirmRoomNumber').textContent = roomNumber;
            document.getElementById('confirmDeleteBtn').onclick = () => deleteRoom(roomId);
            confirmModal.style.display = 'block';
        }

        // Excluir quarto
        async function deleteRoom(roomId) {
            if (!checkAuth()) return;

            const result = await apiRequest(`${API_BASE_URL}/delete/${roomId}`, {
                method: 'DELETE'
            });

            if (result) {
                showAlert('Quarto exclu√≠do com sucesso!');
                closeModal(confirmModal);
                loadRooms();
            }
        }

        // Fechar modal
        function closeModal(modal) {
            modal.style.display = 'none';
        }

        // Filtrar quartos
        function filterRooms(filter) {
            currentFilter = filter;
            renderRooms();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autentica√ß√£o primeiro
            if (!checkAuth()) return;

            // Carregar informa√ß√µes do usu√°rio
            loadUserInfo();

            // Carregar dados iniciais
            loadRooms();

            // Bot√£o adicionar quarto
            document.getElementById('addRoomBtn').addEventListener('click', openAddModal);

            // Bot√µes de filtro
            document.getElementById('filterAvailableBtn').addEventListener('click', () => filterRooms('available'));
            document.getElementById('filterOccupiedBtn').addEventListener('click', () => filterRooms('occupied'));
            document.getElementById('showAllBtn').addEventListener('click', () => filterRooms('all'));

            // Bot√£o atualizar
            document.getElementById('refreshBtn').addEventListener('click', loadRooms);

            // Bot√£o de ordena√ß√£o
            document.getElementById('sortRoomsBtn').addEventListener('click', toggleSortOrder);

            // Bot√µes de gerenciamento de camas
            document.getElementById('addBedBtn').addEventListener('click', addBed);
            document.getElementById('removeBedBtn').addEventListener('click', removeBed);
            document.getElementById('closeBedModalBtn').addEventListener('click', () => closeModal(bedModal));

            // Bot√£o logout
            document.getElementById('logoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });

            // Fechar modais
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    closeModal(modal);
                });
            });

            // Cancelar bot√µes
            document.getElementById('cancelBtn').addEventListener('click', () => closeModal(roomModal));
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal(confirmModal));

            // Fechar modal ao clicar fora
            window.addEventListener('click', function(event) {
                if (event.target === roomModal) {
                    closeModal(roomModal);
                }
                if (event.target === bedModal) {
                    closeModal(bedModal);
                }
                if (event.target === confirmModal) {
                    closeModal(confirmModal);
                }
            });

            // Formul√°rio de quarto
            roomForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!checkAuth()) return;

                const roomId = document.getElementById('roomId').value;
                
                // Validar campos antes de enviar
                const roomNumber = parseInt(document.getElementById('roomNumber').value);
                const roomType = document.getElementById('roomType').value;
                const roomStatus = document.getElementById('roomStatus').value;
                const roomPrice = parseFloat(document.getElementById('roomPrice').value);

                // Validar se os campos obrigat√≥rios est√£o preenchidos
                if (!roomNumber || !roomType || !roomStatus || isNaN(roomPrice)) {
                    showAlert('Por favor, preencha todos os campos obrigat√≥rios!', 'error');
                    return;
                }

                const roomData = {
                    number: roomNumber,
                    roomType: roomType,
                    roomStatus: roomStatus,
                    price: roomPrice
                };

                console.log('Enviando dados:', roomData);

                let result;
                if (roomId) {
                    // Editar quarto existente
                    result = await apiRequest(`${API_BASE_URL}/update/${roomId}`, {
                        method: 'PUT',
                        body: JSON.stringify(roomData)
                    });
                } else {
                    // Adicionar novo quarto
                    result = await apiRequest(`${API_BASE_URL}/insert`, {
                        method: 'POST',
                        body: JSON.stringify(roomData)
                    });
                }

                if (result) {
                    showAlert(roomId ? 'Quarto atualizado com sucesso!' : 'Quarto adicionado com sucesso!');
                    closeModal(roomModal);
                    loadRooms();
                }
            });
        });

        // Tornar fun√ß√µes globais para os event handlers inline
        window.manageBeds = manageBeds;
        window.viewCalendar = viewCalendar;
        window.editRoom = editRoom;
        window.confirmDelete = confirmDelete;
    </script>
</body>
</html>